matrix:
  include:
    - os: linux
      sudo: false
      language: python
      python: "2.7"
      env: WITH_BOOST_THREAD=0
    - os: linux
      sudo: false
      language: python
      python: "3.2"
      env: WITH_BOOST_THREAD=0
    - os: osx
      language: generic
      env: TRAVIS_PYTHON_VERSION="2.7" WITH_BOOST_THREAD=1 CXXFLAGS="-std=c++11"
    - os: osx
      language: generic
      env: TRAVIS_PYTHON_VERSION="3.4.1" WITH_BOOST_THREAD=1 CXXFLAGS="-std=c++11"


addons:
  apt:
    packages:
      - libhdf5-serial-dev
      - libboost-python-dev
      - libjpeg-dev
      - libtiff4-dev
      - libpng12-dev
      - libfftw3-dev
      - libatlas-base-dev
      - cmake

before_script:
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew remove --force $(brew list); brew cleanup                                      ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew update                                                                         ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew tap homebrew/science                                                           ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install cmake                                                                  ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install readline                                                               ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install pyenv                                                                  ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then eval "$(pyenv init -)"                                                              ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then PYTHON_CONFIGURE_OPTS='--enable-shared' pyenv install ${TRAVIS_PYTHON_VERSION}      ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then pyenv rehash                                                                        ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then pyenv global ${TRAVIS_PYTHON_VERSION}                                               ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then which python; python -V; which pip; pip -V                                          ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install hdf5                                                                   ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install boost                                                                  ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install libjpeg                                                                ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install libtiff                                                                ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install libpng                                                                 ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install fftw                                                                   ; fi
  - pip install nose
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then pyenv rehash                                                                        ; fi
  - pip install numpy
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then pyenv rehash                                                                        ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install homebrew/versions/gcc49                                                ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then export CC=$(which gcc-4.9); export CXX=$(which g++-4.9)                             ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]] && [[ ${TRAVIS_PYTHON_VERSION:0:1} -eq 2 ]]; then brew install -v --build-from-source boost-python --with-python ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]] && [[ ${TRAVIS_PYTHON_VERSION:0:1} -eq 3 ]]; then brew install -v --build-from-source boost-python --without-python --with-python3 ; fi

script:
  - mkdir build && cd build
  - cmake -DCMAKE_BUILD_TYPE=Release -DDEPENDENCY_SEARCH_PREFIX=$VIRTUAL_ENV -DAUTOBUILD_TESTS=1 -DAUTOEXEC_TESTS=0 -DWITH_BOOST_THREAD=$WITH_BOOST_THREAD -DPYTHON_VERSION=${TRAVIS_PYTHON_VERSION:0:3} ..
  - make
  - ctest --output-on-failure
